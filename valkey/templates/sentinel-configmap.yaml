{{- if and .Values.replica.enabled .Values.replica.sentinel.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "valkey.fullname" . }}-sentinel-scripts
  labels:
    {{- include "valkey.labels" . | nindent 4 }}
    app.kubernetes.io/component: sentinel
data:
  sentinel-init.sh: |-
    #!/bin/sh
    set -eu

    # Configuration variables from Helm values
    SENTINEL_PORT="{{ .Values.replica.sentinel.port }}"
    MASTER_SET="{{ .Values.replica.sentinel.masterSet }}"
    QUORUM="{{ .Values.replica.sentinel.quorum }}"
    DOWN_AFTER="{{ .Values.replica.sentinel.downAfterMilliseconds }}"
    FAILOVER_TIMEOUT="{{ .Values.replica.sentinel.failoverTimeout }}"
    PARALLEL_SYNCS="{{ .Values.replica.sentinel.parallelSyncs }}"

    # Master is always pod-0 of the valkey statefulset initially
    MASTER_HOST="{{ include "valkey.fullname" . }}-0.{{ include "valkey.headlessServiceName" . }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}"
    MASTER_PORT="{{ .Values.service.port }}"

    SENTINEL_CONF="/data/sentinel.conf"

    log() {
      echo "$(date) $1"
    }

    log "Initializing Sentinel configuration..."

    {{- if .Values.auth.enabled }}
    # Function to get password for a user
    get_user_password() {
      username="$1"
      password_key="${2:-$username}"
      password=""

      {{- if .Values.auth.usersExistingSecret }}
      # Try to get password from existing secret first (priority)
      if [ -f "/valkey-users-secret/$password_key" ]; then
        password=$(cat "/valkey-users-secret/$password_key")
        log "Using password from existing secret for user $username"
      elif [ -f "/valkey-auth-secret/${username}-password" ]; then
        # Fallback to inline password
        password=$(cat "/valkey-auth-secret/${username}-password")
        log "Using inline password for user $username"
      else
        log "ERROR: No password found for user $username"
        return 1
      fi
      {{- else }}
      # Use inline password only
      if [ -f "/valkey-auth-secret/${username}-password" ]; then
        password=$(cat "/valkey-auth-secret/${username}-password")
        log "Using inline password for user $username"
      else
        log "ERROR: No password found for user $username"
        return 1
      fi
      {{- end }}

      echo "$password"
    }
    {{- end }}

    # Create sentinel configuration
    log "Creating sentinel.conf at $SENTINEL_CONF"

    cat > "$SENTINEL_CONF" << EOF
    # Sentinel configuration generated by Helm chart
    port ${SENTINEL_PORT}
    dir /data

    # Announce IP for discovery in Kubernetes
    sentinel resolve-hostnames yes
    sentinel announce-hostnames yes
    sentinel announce-ip ${POD_NAME}.{{ include "valkey.fullname" . }}-sentinel-headless.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}
    sentinel announce-port ${SENTINEL_PORT}

    # Monitor the master
    sentinel monitor ${MASTER_SET} ${MASTER_HOST} ${MASTER_PORT} ${QUORUM}

    # Timing configurations
    sentinel down-after-milliseconds ${MASTER_SET} ${DOWN_AFTER}
    sentinel failover-timeout ${MASTER_SET} ${FAILOVER_TIMEOUT}
    sentinel parallel-syncs ${MASTER_SET} ${PARALLEL_SYNCS}
    EOF

    {{- if .Values.auth.enabled }}
    # Configure authentication for sentinel to connect to master/replicas
    {{- $replUsername := .Values.replica.replicationUser }}
    {{- $replUser := index .Values.auth.aclUsers $replUsername }}
    {{- $replPasswordKey := $replUser.passwordKey | default $replUsername }}
    AUTH_PASSWORD=$(get_user_password "{{ $replUsername }}" "{{ $replPasswordKey }}") || exit 1

    cat >> "$SENTINEL_CONF" << EOF

    # Authentication configuration
    sentinel auth-pass ${MASTER_SET} ${AUTH_PASSWORD}
    EOF

    log "Configured authentication for sentinel"
    {{- end }}

    {{- if .Values.tls.enabled }}
    # TLS configuration
    cat >> "$SENTINEL_CONF" << EOF

    # TLS configuration
    tls-port ${SENTINEL_PORT}
    port 0
    tls-cert-file /tls/{{ .Values.tls.serverPublicKey }}
    tls-key-file /tls/{{ .Values.tls.serverKey }}
    tls-ca-cert-file /tls/{{ .Values.tls.caPublicKey }}
    {{- if .Values.tls.dhParamKey }}
    tls-dh-params-file /tls/{{ .Values.tls.dhParamKey }}
    {{- end }}
    {{- if not .Values.tls.requireClientCertificate }}
    tls-auth-clients no
    {{- end }}
    tls-replication yes
    EOF

    log "Configured TLS for sentinel"
    {{- end }}

    log "Sentinel configuration complete"
    cat "$SENTINEL_CONF"
{{- end }}
