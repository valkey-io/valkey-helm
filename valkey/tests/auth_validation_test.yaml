suite: auth configuration validation
templates:
  - templates/deploy_valkey.yaml
  - templates/init_config.yaml
tests:
  - it: should fail when auth enabled with multiple methods (generateDefaultUser + existingSecret)
    set:
      auth.enabled: true
      auth.generateDefaultUser.enabled: true
      auth.existingSecret: "my-secret"
      auth.aclConfig: ""
    template: templates/deploy_valkey.yaml
    asserts:
      - failedTemplate:
          errorPattern: "Multiple authentication methods.*"

  - it: should fail when auth enabled with multiple methods (generateDefaultUser + aclConfig)
    set:
      auth.enabled: true
      auth.generateDefaultUser.enabled: true
      auth.aclConfig: "user admin on >password ~* &* +@all"
    template: templates/deploy_valkey.yaml
    asserts:
      - failedTemplate:
          errorPattern: "Multiple authentication methods.*"

  - it: should fail when auth enabled with multiple methods (existingSecret + aclConfig)
    set:
      auth.enabled: true
      auth.existingSecret: "my-secret"
      auth.aclConfig: "user admin on >password ~* &* +@all"
    template: templates/deploy_valkey.yaml
    asserts:
      - failedTemplate:
          errorPattern: "Multiple authentication methods.*"

  - it: should fail when auth enabled but no method configured
    set:
      auth.enabled: true
      auth.generateDefaultUser.enabled: false
      auth.existingSecret: ""
      auth.aclConfig: ""
    template: templates/deploy_valkey.yaml
    asserts:
      - failedTemplate:
          errorPattern: "auth.enabled is true but no authentication method.*"

  - it: should fail when auth enabled with only comments in aclConfig
    set:
      auth.enabled: true
      auth.generateDefaultUser.enabled: false
      auth.existingSecret: ""
      auth.aclConfig: |
        # Just comments
        # user default off
    template: templates/deploy_valkey.yaml
    asserts:
      - failedTemplate:
          errorPattern: "auth.enabled is true but no authentication method.*"

  - it: should succeed when auth enabled with generateDefaultUser only
    set:
      auth.enabled: true
      auth.generateDefaultUser.enabled: true
      auth.existingSecret: ""
      auth.aclConfig: ""
    template: templates/deploy_valkey.yaml
    asserts:
      - isKind:
          of: Deployment

  - it: should succeed when auth enabled with existingSecret only
    set:
      auth.enabled: true
      auth.generateDefaultUser.enabled: false
      auth.existingSecret: "my-secret"
      auth.aclConfig: ""
    template: templates/deploy_valkey.yaml
    asserts:
      - isKind:
          of: Deployment

  - it: should succeed when auth enabled with aclConfig only
    set:
      auth.enabled: true
      auth.generateDefaultUser.enabled: false
      auth.existingSecret: ""
      auth.aclConfig: "user admin on >password ~* &* +@all"
    template: templates/deploy_valkey.yaml
    asserts:
      - isKind:
          of: Deployment

  - it: should succeed when auth disabled
    set:
      auth.enabled: false
    template: templates/deploy_valkey.yaml
    asserts:
      - isKind:
          of: Deployment
