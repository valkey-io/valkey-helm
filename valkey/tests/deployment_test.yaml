suite: deployment configuration
templates:
  - templates/deploy_valkey.yaml
  - templates/init_config.yaml
tests:
  - it: should not have auth volumes when auth disabled
    set:
      auth.enabled: false
    template: templates/deploy_valkey.yaml
    asserts:
      - isKind:
          of: Deployment
      - notExists:
          path: spec.template.spec.volumes[?(@.name == "valkey-users-secret")]
      - notExists:
          path: spec.template.spec.volumes[?(@.name == "valkey-auth-secret")]
      - notExists:
          path: spec.template.spec.initContainers[0].volumeMounts[?(@.name == "valkey-users-secret")]
      - notExists:
          path: spec.template.spec.initContainers[0].volumeMounts[?(@.name == "valkey-auth-secret")]

  - it: should have generated volume with inline passwords
    set:
      auth.enabled: true
      auth.aclUsers:
        admin:
          permissions: "~* &* +@all"
          password: "admin-password"
    template: templates/deploy_valkey.yaml
    asserts:
      - isKind:
          of: Deployment
      - contains:
          path: spec.template.spec.volumes
          content:
            name: valkey-auth-secret
            secret:
              secretName: RELEASE-NAME-valkey-auth
              defaultMode: 0400
      - contains:
          path: spec.template.spec.initContainers[0].volumeMounts
          content:
            name: valkey-auth-secret
            mountPath: /valkey-auth-secret
            readOnly: true

  - it: should have users-secret volume with usersExistingSecret
    set:
      auth.enabled: true
      auth.usersExistingSecret: "my-custom-secret"
      auth.aclUsers:
        admin:
          permissions: "~* &* +@all"
    template: templates/deploy_valkey.yaml
    asserts:
      - isKind:
          of: Deployment
      - contains:
          path: spec.template.spec.volumes
          content:
            name: valkey-users-secret
            secret:
              secretName: my-custom-secret
              defaultMode: 0400
      - contains:
          path: spec.template.spec.initContainers[0].volumeMounts
          content:
            name: valkey-users-secret
            mountPath: /valkey-users-secret
            readOnly: true

  - it: should have both volumes with mixed passwords
    set:
      auth.enabled: true
      auth.usersExistingSecret: "my-custom-secret"
      auth.aclUsers:
        admin:
          permissions: "~* &* +@all"
          password: "admin-password"
        readonly:
          permissions: "~* +@read"
    template: templates/deploy_valkey.yaml
    asserts:
      - isKind:
          of: Deployment
      - contains:
          path: spec.template.spec.volumes
          content:
            name: valkey-users-secret
            secret:
              secretName: my-custom-secret
              defaultMode: 0400
      - contains:
          path: spec.template.spec.volumes
          content:
            name: valkey-auth-secret
            secret:
              secretName: RELEASE-NAME-valkey-auth
              defaultMode: 0400

  - it: should have generated volume with aclConfig only
    set:
      auth.enabled: true
      auth.aclConfig: "user admin on >password ~* &* +@all"
    template: templates/deploy_valkey.yaml
    asserts:
      - isKind:
          of: Deployment
      - contains:
          path: spec.template.spec.volumes
          content:
            name: valkey-auth-secret
            secret:
              secretName: RELEASE-NAME-valkey-auth
              defaultMode: 0400

  - it: should have correct replicas
    set:
      replicaCount: 3
    template: templates/deploy_valkey.yaml
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should use custom image
    set:
      image.registry: custom-registry
      image.repository: valkey/valkey
      image.tag: "7.0.0"
    template: templates/deploy_valkey.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: custom-registry/valkey/valkey:7.0.0

  - it: should have service account
    set:
      serviceAccount.create: true
      serviceAccount.name: "custom-sa"
    template: templates/deploy_valkey.yaml
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: custom-sa

  - it: should use image pull policy for containers and initContainers
    set:
      image.pullPolicy: Always
    template: templates/deploy_valkey.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always
      - equal:
          path: spec.template.spec.initContainers[0].imagePullPolicy
          value: Always
