suite: service configuration
templates:
  - templates/service.yaml
tests:
  - it: should have correct default service type
    template: templates/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.type
          value: ClusterIP
  - it: should be able to set custom clusterIP
    set:
      service.clusterIP: "10.0.0.1"
    template: templates/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.clusterIP
          value: "10.0.0.1"
  - it: should have correct default ports
    template: templates/service.yaml
    asserts:
      - contains:
          path: spec.ports
          content:
            port: 6379
            targetPort: tcp
            protocol: TCP
            name: tcp
  - it: should be able to set custom nodePort
    set:
      service.type: "NodePort"
      service.nodePort: 30080
    template: templates/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.ports[0].nodePort
          value: 30080
  - it: should be able to set custom appProtocol
    set:
      service.appProtocol: "my-protocol"
    template: templates/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.ports[0].appProtocol
          value: "my-protocol"
  - it: should be able to set custom loadBalancerClass
    set:
      service.loadBalancerClass: "custom-lb-class"
    template: templates/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.loadBalancerClass
          value: "custom-lb-class"
  - it: shouldn't have loadBalancerClass by default
    template: templates/service.yaml
    asserts:
      - isKind:
          of: Service
      - notExists:
          path: spec.loadBalancerClass
  - it: should have correct selector labels
    template: templates/service.yaml
    asserts:
      - isSubset:
          path: spec.selector
          content:
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/name: valkey
  - it: should pin to pod-0 when replica.enabled is true
    set:
      replica.enabled: true
    template: templates/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.selector["statefulset.kubernetes.io/pod-name"]
          value: RELEASE-NAME-valkey-0
  - it: should not pin to pod-0 when cluster.enabled is true
    set:
      cluster.enabled: true
    template: templates/service.yaml
    asserts:
      - isKind:
          of: Service
      - notExists:
          path: spec.selector["statefulset.kubernetes.io/pod-name"]
  - it: should not pin to pod-0 when both replica.enabled and cluster.enabled are false
    set:
      replica.enabled: false
      cluster.enabled: false
    template: templates/service.yaml
    asserts:
      - isKind:
          of: Service
      - notExists:
          path: spec.selector["statefulset.kubernetes.io/pod-name"]
  - it: should have cluster bus port when cluster.enabled is true
    set:
      cluster.enabled: true
      cluster.busPort: 16379
    template: templates/service.yaml
    asserts:
      - isKind:
          of: Service
      - contains:
          path: spec.ports
          content:
            port: 16379
            targetPort: tcp-bus
            protocol: TCP
            name: tcp-bus
  - it: should not have cluster bus port when cluster.enabled is false
    set:
      cluster.enabled: false
    template: templates/service.yaml
    asserts:
      - isKind:
          of: Service
      - notContains:
          path: spec.ports
          content:
            name: tcp-bus
